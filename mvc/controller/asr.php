<?phpif (!isset($_SESSION['roleId'])) {    header("location: ../user/login");    session_destroy();    exit();}class AsrController{    public function __construct()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }    }    public function admin()    {        ViewAdmin::render("/asr/admin.php");    }    public function wsd()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['btn-insert'])) {            $dir = $_POST['btn-insert'];            $counter = 0;            $counterSuccess = 0;            $counterFailed = 0;            $CSVfp = fopen("$dir", "r");            if ($CSVfp !== FALSE) {                while (!feof($CSVfp)) {                    $row = fgetcsv($CSVfp, "؛");                    $explodeData = explode("؛", $row[0]);                    // insert to table                    $contractNumber = "415-" . $explodeData[0];                    $contractNumber = str_replace('﻿', '', $contractNumber);                    $userDetailes = AsrModel::fetch_bill_by_contract_number($contractNumber);                    $userId = $userDetailes[0]['user_id'];                    $Shomare = $explodeData[17];                    $ZaminKol = $userDetailes[0]['area'];                    if ($ZaminKol == null) {                        $ZaminKol = 0;                    }                    $shomareh_eghtesadi = $userDetailes[0]['economic_code'];                    if ($shomareh_eghtesadi == null) {                        $shomareh_eghtesadi = 0;                    }                    $shenase_meli = $userDetailes[0]['national_number'];                    if ($shenase_meli == null) {                        $shenase_meli = 0;                    }                    $CodePosti = $userDetailes[0]['postal_code'];                    if ($CodePosti == null) {                        $CodePosti = 0;                    }                    $tel = $userDetailes[0]['tele1'];                    if ($tel == null) {                        $tel = 0;                    }//                    $companyName = $explodeData[1];   // برای دوره اول از فایل حسابداری می خوانیم اما دوره های بعدی که مشترکین اطلاعات را در تیبل کمپانی وارد کردند از آنجا می خوانیم                    $fetchCompany = AsrModel::fetch_company_name_by_contract($contractNumber);                    $companyName = $fetchCompany['contract_name'];                    $address = $explodeData[2];                    $ShenaseGhabz = $explodeData[3];                    $ShenasePardakht = $explodeData[4];                    $MizanMasraf = round($explodeData[5]);                    $Nerkh = round($explodeData[6]);                    $HazineNosazi = round($explodeData[8]);                    if ($HazineNosazi == null) {                        $HazineNosazi = 0;                    }                    $Aboneman = round($explodeData[7]) + round($explodeData[8]);                    $HazineTaviz = round($explodeData[9]);                    if ($HazineTaviz == null) {                        $HazineTaviz = 0;                    }                    $HazineKharabi = round($explodeData[10]);                    if ($HazineKharabi == null) {                        $HazineKharabi = 0;                    }                    $HazineAbTankeri = round($explodeData[11]);                    if ($HazineAbTankeri == null) {                        $HazineAbTankeri = 0;                    }                    $MablaghFazelab = round($explodeData[12]);                    if ($MablaghFazelab == null) {                        $MablaghFazelab = 0;                    }                    $MablaghJarime = round($explodeData[13]);                    if ($MablaghJarime == null) {                        $MablaghJarime = 0;                    }                    $khadamatAbresani = $HazineTaviz + $HazineKharabi + $HazineAbTankeri + $MablaghFazelab + $MablaghJarime;                    $waterAmount = $Nerkh * $MizanMasraf;                    $MablaghMaliat = round($explodeData[14]);                    $GhabelPardakht = round($explodeData[15]);                    $CodeQabz = $explodeData[16];                    $AzTarikh = $explodeData[18];                    $TaTarikh = $explodeData[19];                    $AbBaha = round($explodeData[20]);                    $MohlatPardakht = $explodeData[21];                    $NameDoreh = $explodeData[22];                    $EnsheabQotr = $explodeData[23];                    if ($EnsheabQotr == 10) {                        $EnsheabQotr = 1.2;                    } elseif ($EnsheabQotr == 11) {                        $EnsheabQotr = 1;                    } elseif ($EnsheabQotr == 12) {                        $EnsheabQotr = 0.5;                    } elseif ($EnsheabQotr == 13) {                        $EnsheabQotr = 3;                    } elseif ($EnsheabQotr == 14) {                        $EnsheabQotr = 1.5;                    } elseif ($EnsheabQotr == 16) {                        $EnsheabQotr = 3.4;                    } elseif ($EnsheabQotr == 17) {                        $EnsheabQotr = 2;                    }                    $BedehiQ = round($explodeData[24]);                    $ShContorQabli = $explodeData[26];                    $ShContorFely = $explodeData[27];                    $TarikhGhFeli = $explodeData[29];                    $TarikhGhQabli = $explodeData[30];                    $periodLastId = AsrModel::fetch_bill_by_period_id($Shomare);                    if (isset($_POST['insert-user'])) {                    }                    if (isset($userId)) {                        AsrModel::water_billing($userId, $contractNumber, $companyName, $address, $ShenaseGhabz, $ShenasePardakht, $MizanMasraf,                            $Nerkh, $Aboneman, $khadamatAbresani, $MablaghMaliat, $GhabelPardakht, $CodeQabz, $Shomare, $AzTarikh, $TaTarikh, $AbBaha,                            $MohlatPardakht, $NameDoreh, $BedehiQ, $CodePosti, $ShContorQabli, $ShContorFely, $ZaminKol, $TarikhGhFeli, $TarikhGhQabli,                            $waterAmount, $EnsheabQotr, $shomareh_eghtesadi, $shenase_meli, $tel                        );                        $data['موفق'][] = $companyName . '->' . "ثبت شد";                        $counterSuccess++;                    } else {                        $data['ناموفق'][] = $companyName . '->' . "کاربر پنل کاربری ندارد- قبض صادر نگردید";                        $counterFailed++;                    }                    $counter++;                }                $data['تعداد کل'] = $counter;                $data['تعداد صدور موفق'] = $counterSuccess;                $data['تعداد ناموفق'] = $counterFailed;                if (isset($periodLastId)) {                    ViewAdmin::render("/asr/wsd/summery.php", $data);                }            }            fclose($CSVfp);        } else {            ViewAdmin::render("/asr/wsd/water-billing.php");        }    }    public function wsdArray($dir)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        $counter = 0;        $counterSuccess = 0;        $counterFailed = 0;        $CSVfp = fopen("$dir", "r");        if ($CSVfp !== FALSE) {            while (!feof($CSVfp)) {                while ($row = fgetcsv($CSVfp, "؛")) {                    $explodeData = explode("؛", $row[0]);                    // insert to table                    $contractNumber = "415-" . $explodeData[0];                    $contractNumber = str_replace('﻿', '', $contractNumber);                    $data['contractNumber'] = str_replace('﻿', '', $contractNumber);                    $userDetailes = AsrModel::fetch_bill_by_contract_number($data['contractNumber']);                    $data['userId'] = $userDetailes[0]['user_id'];                    $data['Shomare'] = $explodeData[17];                    $data['$ZaminKol'] = $userDetailes[0]['area'];                    if ($data['$ZaminKol'] == null) {                        $data['$ZaminKol'] = 0;                    }                    $data['shomareh_eghtesadi'] = $userDetailes[0]['economic_code'];                    if ($data['shomareh_eghtesadi'] == null) {                        $data['shomareh_eghtesadi'] = 0;                    }                    $data['shenase_meli'] = $userDetailes[0]['national_number'];                    if ($data['shenase_meli'] == null) {                        $data['shenase_meli'] = 0;                    }                    $data['CodePosti'] = $userDetailes[0]['postal_code'];                    if ($data['CodePosti'] == null) {                        $data['CodePosti'] = 0;                    }                    $data['tel'] = $userDetailes[0]['tele1'];                    if ($data['tel'] == null) {                        $data['tel'] = 0;                    }                    $data['companyName'] = $explodeData[1];                    $data['address'] = $explodeData[2];                    $data['ShenaseGhabz'] = $explodeData[3];                    $data['ShenasePardakht'] = $explodeData[4];                    $data['MizanMasraf'] = round($explodeData[5]);                    $data['Nerkh'] = round($explodeData[6]);                    $HazineNosazi = round($explodeData[8]);                    if ($HazineNosazi == null) {                        $data['HazineNosazi'] = 0;                    }                    $data['Aboneman'] = round($explodeData[7]) + round($explodeData[8]);                    $HazineTaviz = round($explodeData[9]);                    if ($HazineTaviz == null) {                        $data['HazineTaviz'] = 0;                    }                    $HazineKharabi = round($explodeData[10]);                    if ($HazineKharabi == null) {                        $data['HazineKharabi'] = 0;                    }                    $HazineAbTankeri = round($explodeData[11]);                    if ($HazineAbTankeri == null) {                        $data['HazineAbTankeri'] = 0;                    }                    $MablaghFazelab = round($explodeData[12]);                    if ($MablaghFazelab == null) {                        $data['MablaghFazelab'] = 0;                    }                    $MablaghJarime = round($explodeData[13]);                    if ($MablaghJarime == null) {                        $data['MablaghJarime'] = 0;                    }                    $data['khadamatAbresani'] = $HazineTaviz + $HazineKharabi + $HazineAbTankeri + $MablaghFazelab + $MablaghJarime;                    $data['waterAmount'] = $data['Nerkh'] * $data['MizanMasraf'];                    $data['MablaghMaliat'] = round($explodeData[14]);                    $data['GhabelPardakht'] = round($explodeData[15]);                    $data['CodeQabz'] = $explodeData[16];                    $data['AzTarikh'] = $explodeData[18];                    $data['TaTarikh'] = $explodeData[19];                    $data['AbBaha'] = round($explodeData[20]);                    $data['MohlatPardakht'] = $explodeData[21];                    $data['NameDoreh'] = $explodeData[22];                    $EnsheabQotr = $explodeData[23];                    if ($EnsheabQotr == 10) {                        $data['EnsheabQotr'] = 1.2;                    } elseif ($EnsheabQotr == 11) {                        $data['EnsheabQotr'] = 1;                    } elseif ($EnsheabQotr == 12) {                        $data['EnsheabQotr'] = 0.5;                    } elseif ($EnsheabQotr == 13) {                        $data['EnsheabQotr'] = 3;                    } elseif ($EnsheabQotr == 14) {                        $data['EnsheabQotr'] = 1.5;                    } elseif ($EnsheabQotr == 16) {                        $data['EnsheabQotr'] = 3.4;                    } elseif ($EnsheabQotr == 17) {                        $data['EnsheabQotr'] = 2;                    }                    $data['BedehiQ'] = round($explodeData[24]);                    $data['ShContorQabli'] = $explodeData[26];                    $data['ShContorFely'] = $explodeData[27];                    $data['TarikhGhFeli'] = $explodeData[29];                    $data['TarikhGhQabli'] = $explodeData[30];                    $periodLastId = AsrModel::fetch_bill_by_period_id($data['Shomare']);                    if (isset($periodLastId)) {                        $data['periodLastId'] = 1;                    } else {                        $data['periodLastId'] = 0;                    }                    return $data;                }            }        }    }    public function importBillingPayed()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1820 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['btn-insert'])) {            $counter = 0;            $counterSuccess = 0;            $counterFailed = 0;            $dir = $_POST['btn-insert'];            $data = AsrModel::importExcelSpreadsheet($dir);            $arr_data = $data['values'];            $row = 0;            $counter = 0;            $duplicated = 0;            foreach ($arr_data as $data) {                $payedDate = $data[0];                $payedDate = str_split($payedDate, 2);                $payedDate = $payedDate[0] . '-' . $payedDate[1] . '-' . $payedDate[2];//                echo $payedDate.br();                $payedFor = $data[1];                $amount = $data[2];                $shenaseGhabz = $data[3] + 0;                $shenasePardakht = $data[4] + 0;                $rrn = $data[5];                $cardNumber = ltrim($data[6], '0');                $fetch = AsrModel::fetch_bill_payed_bank($shenaseGhabz, $shenasePardakht);                if ($fetch == null) {                    AsrModel::insert_bill_payed_bank($payedDate, $payedFor, $amount, $shenaseGhabz, $shenasePardakht, $rrn, $cardNumber);                    $counter++;                } else {                    $duplicated++;                }                $row++;            }            messageAdmin("success", '<span>تعداد ردیف فایل اکسل: ' . $row . '</span><br><br>                <span>تعداد ثبت موفق: ' . $counter . '</span><br><br>                <span>شناسه قبض و شناسه پرداخت تکراری:' . $duplicated . '</span><br><br>            <a class="btn btn-default" href="/asr/admin">بازگشت</a>', true);        } else {            ViewAdmin::render("/asr/financial/import-billing-payed.php");        }    }    public function importWsCounter()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['btn-insert'])) {            $dir = $_POST['btn-insert'];            $counter = 0;            $counterFailed = 0;            $data = AsrModel::importExcelSpreadsheet($dir);            $arr_data = $data['values'];            $row = 0;            $counter = 0;            $duplicated = 0;            foreach ($arr_data as $data) {                $contractNumber= '415-'.$data[0];                $readDate = $data[1];                $readDate = str_replace('/', '-', $readDate);                $waterCounterNumber = intval($data[2]);                $periodName= $data[3];                $periodId= intval($data[4]);                $fetchUserId= AsrModel::fetch_userid($contractNumber);                $userId= $fetchUserId['user_id'];                $fetchDuplicate = AsrModel::fetch_water_counter_by_period_number($periodId, $userId);                if ($fetchDuplicate == null AND $userId!=null) {                    AsrModel::insert_water_counter_excel($userId, $periodId, $periodName, $waterCounterNumber, 'فایل اکسل', $readDate);                    $counter++;                }elseif ($userId==null) {                    $counterFailed++;                }else{                    $duplicated++;                }                $row++;            }            messageAdmin("success", '<span>تعداد ردیف فایل اکسل: ' . $row . '</span><br><br>                <span>تعداد ثبت موفق: ' . $counter . '</span><br><br>                <span>قرائت تکراری:' . $duplicated . '</span><br><br>                <span class="alert-warning">مشترک پنل کاربری ندارد:' .' '. $counterFailed . '</span><br><br>            <a class="btn btn-default" href="/asr/admin">بازگشت</a>', true);        } else {            ViewAdmin::render("/asr/wsd/import-ws-counter.php");        }    }    public function StarterChargeDebit()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1820 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['btn-insert'])) {            $dir = $_POST['btn-insert'];            $counter = 0;            $counterSuccess = 0;            $counterFailed = 0;            $dataExel = ImportExcel($dir);            $arr_data = $dataExel['values'];            $row = 0;            foreach ($arr_data as $data) {                $contractNumber = '415-'.$data['A'];                $area = $data['B'];                $debit = $data['C'];                $debitYear = $data['D'];                $fetch = AsrModel::fetch_userId_by_contractNumber($contractNumber);                $userId= $fetch['user_id'];                if ($userId!=null) {//                    echo "UPDATE `s_company` SET `area`="."'".$area."'"." "." WHERE `user_id`=".$userId.";"."</br>" ;                    AsrModel::insert_starter_charge_debit($userId, $contractNumber, $area, $debitYear, $debit);                    $counterSuccess++;                }else{                    $counterFailed++;                    $failed[]= $contractNumber;//                    echo "<span>قرارداد پنل کاربری ندارد:" . $failed. "</span><br><br>";                }                $row++;            }            messageAdmin("success", '<span>تعداد ردیف فایل اکسل: ' . $row . '</span><br><br>               <span>تعداد ثبت موفق: ' . $counterSuccess . '</span><br><hr> <i class="fa fa-warning"> خطا </i>  <span class="alert-warning"><br><br>'               . $counterFailed .' مشترک زیر پنل کاربری ندارند: <br><br>'.                implode(" , ", $failed)                .'</span><br><br><br><a class="btn btn-default" href="/asr/admin">بازگشت</a>', true);        } else {            ViewAdmin::render("/asr/financial/starter-charge_debit.php");        }    }    public function StarterChargeDebitServerSide()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1820 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (!isset($_SESSION['user_id'])) {            header('location:' . fullbaseUrl() . '/user/login');            exit;        }        // DB table to use        $table = 's_charge_debit';        $primaryKey = 'charge_debit_id';        global $config;        $sql_details = array(            'user' => $config ['db']['user'],            'pass' => $config ['db']['pass'],            'db' => $config ['db']['name'],            'host' => $config ['db']['host'],        );        $joinQuery = "FROM   `{$table}`  ";        $columns = array(            array('db' => '`s_charge_debit`.`charge_debit_id`', 'dt' => '0', 'field' => 'charge_debit_id'),            array('db' => '`s_charge_debit`.`contract_number`', 'dt' => '1', 'field' => 'contract_number'),            array('db' => '`s_charge_debit`.`debit`',           'dt' => '2', 'field' => 'debit'),            array('db' => '`s_charge_debit`.`area`',            'dt' => '3', 'field' => 'area'),            array('db' => '`s_charge_debit`.`debit_year`',      'dt' => '4', 'field' => 'debit_year'),        );        $joinQuery = "FROM  `{$table}`  ";        $extraWhere = 'ORDER BY \'`s_charge_debit`.`charge_debit_id`\' ASC';        echo json_encode(//            SSPCustom::simple( $_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery)            SSPCustom::simple($_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery, '', '', '', $extraWhere)        );    }    public function catalogPayedBankDelete()    {        if (isset($_GET['delete'])) {            $id = $_GET['delete'];            $result_delete = AsrModel::delete_shenase_payed_bank($id);            if ($result_delete) {//                echo'<script>window.location.href="'.baseUrl().'/asr/catalogPayedBank"</script>';//                echo json_encode(array(//                    'status' => '1'//                ));                echo "</br>&nbsp&nbsp&nbsp<span class='h5'>" . "رکورد شماره" . " " . $id . " " . "حذف گردید" . "</span></br>";                exit();            } else {                echo '<script>alert("Delete Failed")</script>';            }        }    }    public function catalogPayedBank()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1820 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        ViewAdmin::render("/asr/financial/catalog-payed-bank.php");    }    public function getBillPayedBank()    {        if ($_POST["billPayId"]) {            $data = AsrModel::fetch_bill_payed_bank_by_id($_POST["billPayId"]);            $row = array(                'id' => $data['payed_bank_id'],                'date' => $data['b_payed_date'],                'payedFor' => $data['b_payed_for'],                'amount' => $data['b_amount'],                'shenaseGhabz' => $data['b_shenase_ghabz'],                'shenasePardakht' => $data['b_shenase_pardakht'],                'rrn' => $data['b_rrn'],                'cardNumber' => $data['b_card_number'],            );            echo json_encode($row);        }    }    public function actionBillPayedBank()    {        if (isset($_POST['payId']) && $_POST['action'] == 'updatePayBank') {            $id = $_POST['payId'];            $payedDate = $_POST['date'];            $payedFor = $_POST['payed-for'];            $amount = $_POST['amount'];            $shenaseGhabz = $_POST['shenase-ghabz'];            $shenasePardakht = $_POST['shenase-pardakht'];            $rrn = $_POST['rrn'];            $cardNumber = $_POST['card-number'];            AsrModel::update_bill_payed_bank($id, $payedDate, $payedFor, $amount, $shenaseGhabz, $shenasePardakht, $rrn, $cardNumber);        }        if (isset($_POST['action']) && $_POST['action'] == 'addPayedBank') {            $payedDate = $_POST['date'];            $payedFor = $_POST['payed-for'];            $amount = $_POST['amount'];            $shenaseGhabz = $_POST['shenase-ghabz'];            $shenasePardakht = $_POST['shenase-pardakht'];            $rrn = $_POST['rrn'];            $cardNumber = $_POST['card-number'];            AsrModel::insert_bill_payed_bank($payedDate, $payedFor, $amount, $shenaseGhabz, $shenasePardakht, $rrn, $cardNumber);        }        if (isset($_REQUEST['id'])) {            $id = intval($_REQUEST['id']);            $data = AsrModel::fetch_bill_payed_bank_by_id($id);            ViewAdmin::renderPartial("/asr/financial/catalog-payed-bank-edit.php", $data);        }    }    public function BillingPayedServerSide()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1820 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (!isset($_SESSION['user_id'])) {            header('location:' . fullbaseUrl() . '/user/login');            exit;        }        // DB table to use        $table = 's_bill_payed_bank';        $primaryKey = 'payed_bank_id';        global $config;        $sql_details = array(            'user' => $config ['db']['user'],            'pass' => $config ['db']['pass'],            'db' => $config ['db']['name'],            'host' => $config ['db']['host'],        );        $joinQuery = "FROM   `{$table}`  ";        $columns = array(            array('db' => '`s_bill_payed_bank`.`payed_bank_id`', 'dt' => '0', 'field' => 'payed_bank_id'),            array('db' => '`s_bill_payed_bank`.`b_payed_date`', 'dt' => '1', 'field' => 'b_payed_date'),            array('db' => '`s_bill_payed_bank`.`b_payed_for`', 'dt' => '2', 'field' => 'b_payed_for'),            array('db' => '`s_bill_payed_bank`.`b_amount`', 'dt' => '3', 'field' => 'b_amount'),            array('db' => '`s_bill_payed_bank`.`b_shenase_ghabz`', 'dt' => '4', 'field' => 'b_shenase_ghabz'),            array('db' => '`s_bill_payed_bank`.`b_shenase_pardakht`', 'dt' => '5', 'field' => 'b_shenase_pardakht'),            array('db' => '`s_bill_payed_bank`.`b_rrn`', 'dt' => '6', 'field' => 'b_rrn'),            array('db' => '`s_bill_payed_bank`.`b_card_number`', 'dt' => '7', 'field' => 'b_card_number'),//            array('db' => '`s_bill_payed_bank`.`b_card_number`',        'dt'  => '8'  ,      'field'  => 'b_card_number'),        );        $joinQuery = "FROM  `{$table}`  ";        $extraWhere = 'ORDER BY `payed_bank_id`.`payed_bank_id` DESC';        echo json_encode(//            SSPCustom::simple( $_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery)            SSPCustom::simple($_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery, '', '', '', $extraWhere)        );    }//دوره کنتور خوانی    public function WsdPeriod()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        ViewAdmin::render("/asr/wsd/wsd-period.php");    }    public function wsdPeriodServerSide()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1820 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (!isset($_SESSION['user_id'])) {            header('location:' . fullbaseUrl() . '/user/login');            exit;        }        // DB table to use        $table = 's_water_period';        $primaryKey = 'water_table_id';        global $config;        $sql_details = array(            'user' => $config ['db']['user'],            'pass' => $config ['db']['pass'],            'db' => $config ['db']['name'],            'host' => $config ['db']['host'],        );        $joinQuery = "FROM   `{$table}`  ";        $columns = array(            array('db' => '`s_water_period`.`water_table_id`', 'dt' => '0', 'field' => 'water_table_id'),            array('db' => '`s_water_period`.`period_id`', 'dt' => '1', 'field' => 'period_id'),            array('db' => '`s_water_period`.`period_name`', 'dt' => '2', 'field' => 'period_name'),            array('db' => '`s_water_period`.`start_date`', 'dt' => '3', 'field' => 'start_date'),            array('db' => '`s_water_period`.`end_date`', 'dt' => '4', 'field' => 'end_date'),        );        $joinQuery = "FROM  `{$table}`  ";        $extraWhere = 'ORDER BY `s_water_period`.`water_table_id` DESC';        echo json_encode(//            SSPCustom::simple( $_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery)            SSPCustom::simple($_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery, '', '', '', $extraWhere)        );    }    public function actionWsdPeriod()    {        if (isset($_POST['payId']) && $_POST['action'] == 'updateRecord') {            $id = $_POST['payId'];            $periodNumber = $_POST['period_number'];            $periodName   = $_POST['period_name'];            $startDate    = $_POST['start_date'];            $endDate      = $_POST['end_date'];            AsrModel::update_wsd_period($id, $periodNumber, $periodName, $startDate, $endDate);        }        if (isset($_POST['action']) && $_POST['action'] == 'addRecord') {            $periodNumber = $_POST['period_number'];            $periodName   = $_POST['period_name'];            $startDate    = $_POST['start_date'];            $endDate      = $_POST['end_date'];            AsrModel::insert_wsd_period($periodNumber, $periodName, $startDate, $endDate);        }        if (isset($_REQUEST['id'])) {            $id = intval($_REQUEST['id']);            $data = AsrModel::fetch_bill_payed_bank_by_id($id);            ViewAdmin::renderPartial("/asr/financial/catalog-payed-bank-edit.php", $data);        }    }    public function getWsdPeriod()    {        if ($_POST["billPayId"]) {            $data = AsrModel::fetch_wsd_period_by_id($_POST["billPayId"]);            $row = array(            'id' => $data['water_table_id'],            'periodNumber'  => $data['period_id'],            'periodName'    => $data['period_name'],            'startDate'     => $data['start_date'],            'endDate'       => $data['end_date'],            );            echo json_encode($row);        }    }    public function wsdPeriodDelete()    {        if (isset($_GET['delete'])) {            $id = $_GET['delete'];            $result_delete = AsrModel::delete_wsd_period($id);            if ($result_delete) {                echo "</br>&nbsp&nbsp&nbsp<span class='h5'>" . "رکورد شماره" . " " . $id . " " . "حذف گردید" . "</span></br>";                exit();            } else {                echo '<script>alert("Delete Failed")</script>';            }        }    }//water billing external csv همحوانی پرداخت های بانکی قبض    public function run_import()    {//        var_dump($_FILES);        $file_upload = $_FILES['xlsx'];        var_dump($file_upload);        $dir = 'uploader/excel/';        if (!is_dir($dir)) {            mkdir($dir);        }        $from = $_FILES ['xlsx']['tmp_name'];        $to = 'uploader/excel/' . $file_upload['name'];        var_dump($to);        move_uploaded_file($from, $to);//        $file_path = 'uploader/files/excel/' . $file_upload['file_name'];        $file_path = $to;        //load the excel library//    $this->load->library('excel');        require_once 'includes/phpexcel/classes/PHPExcel.php';        //read file from path        $inputFileType = PHPExcel_IOFactory::identify($file_path);        //die(print_r($inputFileType));        /**  Create a new Reader of the type defined in $inputFileType  **/        $objReader = PHPExcel_IOFactory::createReader($inputFileType);        $objPHPExcel = $objReader->load($file_path);        //die(print_r($objPHPExcel));        //get only the Cell Collection        $cell_collection = $objPHPExcel->getActiveSheet()->getCellCollection();        //extract to a PHP readable array format        foreach ($cell_collection as $cell) {            $column = $objPHPExcel->getActiveSheet()->getCell($cell)->getColumn();            $row = $objPHPExcel->getActiveSheet()->getCell($cell)->getRow();            $data_value = $objPHPExcel->getActiveSheet()->getCell($cell)->getValue();            //header will/should be in row 1 only. of course this can be modified to suit your need.            if ($row == 1) {                $header[$row][$column] = $data_value;            } else {                $arr_data[$row][$column] = $data_value;            }        }        //send the data in an array format        $data['header'] = $header;        $data['values'] = $arr_data;        return $arr_data and $header;    }    public function download($file)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if (!empty($file)) {            $fileName = basename($file);            $filePath = 'uploader/waterBillingBank/' . $fileName;            if (!empty($fileName) && file_exists($filePath)) {                // Define headers                header("Cache-Control: public");                header("Content-Description: File Transfer");                header("Content-Disposition: attachment; filename=$fileName");                header("Content-Type: application/zip");                header("Content-Transfer-Encoding: binary");                // Read the file                readfile($filePath);                exit;            } else {                echo 'The file does not exist.';            }        }    }    public function getdata($csvFile)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        $file_handle = fopen($csvFile, 'r');        while (!feof($file_handle)) {            $line_of_text[] = fgetcsv($file_handle);        }        fclose($file_handle);        return $line_of_text;    }    public function parse_csv_file($dir)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        $csv = Array();        $rowcount = 0;        if (($handle = fopen($dir, "r")) !== FALSE) {            $max_line_length = defined('MAX_LINE_LENGTH') ? MAX_LINE_LENGTH : 10000;            $header = fgetcsv($handle, $max_line_length);            $header_colcount = count($header);            while (($row = fgetcsv($handle, $max_line_length)) !== FALSE) {                $row_colcount = count($row);                if ($row_colcount == $header_colcount) {                    $entry = array_combine($header, $row);                    $csv[] = $entry;                } else {                    error_log("csvreader: Invalid number of columns at line " . ($rowcount + 2) . " (row " . ($rowcount + 1) . "). Expected=$header_colcount Got=$row_colcount");                    return null;                }                $rowcount++;            }            //echo "Totally $rowcount rows found\n";            fclose($handle);        } else {            error_log("csvreader: Could not read CSV \"$dir\"");            return null;        }        return $csv;    }    public function wsdReports()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] == 1821 || $_SESSION['roleId'] == 1820 || $_SESSION['roleId'] == 1818 ||  $_SESSION['roleId'] == 1819) {            if (isset($_POST['btn-report'])) {                $this->report_water($_POST);            } else {                ViewAdmin::render("/asr/wsd/wsd-reports.php");            }        } else {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }    }    private function report_water($post)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        $info['periodId'] = $post['periodId'];        $contract = explode('-', $post['gharardad']);        if ($contract[1] > null) {            $contract = $contract[0] . '-' . $contract[1];        } else {            $contract = null;        }        $info['contract_number'] = $contract;        $info['rrn'] = $post['codePeygiry'];        $info['payment_time'] = $post['date'];        $info['payment_time'] = str_replace('/', '-', $info['payment_time']);        $data = $this->fetch_water_bill($info);        if (isset($data)) {            ViewAdmin::render("/asr/wsd/wsd-reports.php", $data);        } else {            $data['eroor'] = "مفداری وجود ندارد";            ViewAdmin::render("/asr/wsd/wsd-reports.php", $data);        }    }    private function fetch_water_bill($info)    {        if ($info['periodId'] > 0) {            $data = AsrModel::fetch_water_bill_by_period_id($info['periodId']);        }        if ($info['contract_number'] > 0) {            $data = AsrModel::fetch_water_bill_by_contract_number($info['contract_number']);        }        if ($info['rrn'] > 0) {            $data = AsrModel::fetch_water_bill_by_rrn($info['rrn']);        }        if ($info['payment_time'] > 0) {            $data = AsrModel::fetch_water_bill_by_payment_time($info['payment_time']);        }        if (isset($data)) {            return $data;        }    }    //دانلود فایل    public function subscriptionBilling()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['btn-insert'])) {            $dir = $_POST['btn-insert'];            $counter = 0;            $counterSuccess = 0;            $counterFailed = 0;            $CSVfp = fopen("$dir", "r");            if ($CSVfp !== FALSE) {                while (!feof($CSVfp)) {                    $row = fgetcsv($CSVfp, "؛");                    $explodeData = explode("؛", $row[0]);                    // insert to table                    $contractNumber = "415-" . $explodeData[0];                    $contractNumber = str_replace('﻿', '', $contractNumber);                    $userDetailes = AsrModel::fetch_bill_by_contract_number($contractNumber);                    $userId = $userDetailes[0]['user_id'];                    $Shomare = $explodeData[17];                    $ZaminKol = $userDetailes[0]['area'];                    if ($ZaminKol == null) {                        $ZaminKol = 0;                    }                    $shomareh_eghtesadi = $userDetailes[0]['economic_code'];                    if ($shomareh_eghtesadi == null) {                        $shomareh_eghtesadi = 0;                    }                    $shenase_meli = $userDetailes[0]['national_number'];                    if ($shenase_meli == null) {                        $shenase_meli = 0;                    }                    $CodePosti = $userDetailes[0]['postal_code'];                    if ($CodePosti == null) {                        $CodePosti = 0;                    }                    $tel = $userDetailes[0]['tele1'];                    if ($tel == null) {                        $tel = 0;                    }                    $companyName = $explodeData[1];   // برای دوره اول از فایل حسابداری می خوانیم اما دوره های بعدی که مشترکین اطلاعات را در تیبل کمپانی وارد کردند از آنجا می خوانیم                    $address = $explodeData[2];                    $ShenaseGhabz = $explodeData[3];                    $ShenasePardakht = $explodeData[4];                    $MizanMasraf = round($explodeData[5]);                    $Nerkh = round($explodeData[6]);                    $HazineNosazi = round($explodeData[8]);                    if ($HazineNosazi == null) {                        $HazineNosazi = 0;                    }                    $Aboneman = round($explodeData[7]) + round($explodeData[8]);                    $HazineTaviz = round($explodeData[9]);                    if ($HazineTaviz == null) {                        $HazineTaviz = 0;                    }                    $HazineKharabi = round($explodeData[10]);                    if ($HazineKharabi == null) {                        $HazineKharabi = 0;                    }                    $HazineAbTankeri = round($explodeData[11]);                    if ($HazineAbTankeri == null) {                        $HazineAbTankeri = 0;                    }                    $MablaghFazelab = round($explodeData[12]);                    if ($MablaghFazelab == null) {                        $MablaghFazelab = 0;                    }                    $MablaghJarime = round($explodeData[13]);                    if ($MablaghJarime == null) {                        $MablaghJarime = 0;                    }                    $khadamatAbresani = $HazineTaviz + $HazineKharabi + $HazineAbTankeri + $MablaghFazelab + $MablaghJarime;                    $waterAmount = $Nerkh * $MizanMasraf;                    $MablaghMaliat = round($explodeData[14]);                    $GhabelPardakht = round($explodeData[15]);                    $CodeQabz = $explodeData[16];                    $AzTarikh = $explodeData[18];                    $TaTarikh = $explodeData[19];                    $AbBaha = round($explodeData[20]);                    $MohlatPardakht = $explodeData[21];                    $NameDoreh = $explodeData[22];                    $EnsheabQotr = $explodeData[23];                    if ($EnsheabQotr == 10) {                        $EnsheabQotr = 1.2;                    } elseif ($EnsheabQotr == 11) {                        $EnsheabQotr = 1;                    } elseif ($EnsheabQotr == 12) {                        $EnsheabQotr = 0.5;                    } elseif ($EnsheabQotr == 13) {                        $EnsheabQotr = 3;                    } elseif ($EnsheabQotr == 14) {                        $EnsheabQotr = 1.5;                    } elseif ($EnsheabQotr == 16) {                        $EnsheabQotr = 3.4;                    } elseif ($EnsheabQotr == 17) {                        $EnsheabQotr = 2;                    }                    $BedehiQ = round($explodeData[24]);                    $ShContorQabli = $explodeData[26];                    $ShContorFely = $explodeData[27];                    $TarikhGhFeli = $explodeData[29];                    $TarikhGhQabli = $explodeData[30];                    $periodLastId = AsrModel::fetch_bill_by_period_id($Shomare);                    if (isset($_POST['insert-user'])) {                    }                    if (isset($userId)) {                        AsrModel::water_billing($userId, $contractNumber, $companyName, $address, $ShenaseGhabz, $ShenasePardakht, $MizanMasraf,                            $Nerkh, $Aboneman, $khadamatAbresani, $MablaghMaliat, $GhabelPardakht, $CodeQabz, $Shomare, $AzTarikh, $TaTarikh, $AbBaha,                            $MohlatPardakht, $NameDoreh, $BedehiQ, $CodePosti, $ShContorQabli, $ShContorFely, $ZaminKol, $TarikhGhFeli, $TarikhGhQabli,                            $waterAmount, $EnsheabQotr, $shomareh_eghtesadi, $shenase_meli, $tel                        );                        $data['موفق'][] = $companyName . '->' . "ثبت شد";                        $counterSuccess++;                    } else {                        $data['ناموفق'][] = $companyName . '->' . "کاربر پنل کاربری ندارد- قبض صادر نگردید";                        $counterFailed++;                    }                    $counter++;                }                $data['تعداد کل'] = $counter;                $data['تعداد صدور موفق'] = $counterSuccess;                $data['تعداد ناموفق'] = $counterFailed;                if (isset($periodLastId)) {                    ViewAdmin::render("/asr/wsd/summery.php", $data);                }            }            fclose($CSVfp);        } else {            ViewAdmin::render("/asr/wsd/subscription-billing.php");        }    }    public function renovationBilling()    {    }    public function users()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] == '1820' || $_SESSION['roleId'] == '1821' || $_SESSION['roleId'] == '1822' || $_SESSION['roleId'] == '1823' || $_SESSION['roleId'] == '1818' || $_SESSION['roleId'] == '1819') {//            $data = $this->fetch_users();            viewAdmin::render("/asr/user/list.php");        } else {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }    }    private function fetch_users()    {        $data = AsrModel::fetch_users();        return $data;    }    public function usersListServerSide()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        // DB table to use        $table = 's_company';        $primaryKey = 'company_id';        global $config;        $sql_details = array(            'user' => $config ['db']['user'],            'pass' => $config ['db']['pass'],            'db' => $config ['db']['name'],            'host' => $config ['db']['host'],        );        $columns = array(            array('db' => '`s_company`.`contract_number`',        'dt' => '0', 'field' => 'contract_number'),            array('db' => '`s_company`.`contract_name`',          'dt' => '1', 'field' => 'contract_name'),            array('db' => '`s_company`.`company_name`',           'dt' => '2', 'field' => 'company_name'),            array('db' => '`s_company`.`noe_shakhs`',             'dt' => '3', 'field' => 'noe_shakhs'),            array('db' => '`s_company`.`national_number`',        'dt' => '4', 'field' => 'national_number'),            array('db' => '`s_company`.`economic_code`',          'dt' => '5', 'field' => 'economic_code'),            array('db' => '`s_company`.`area`',                   'dt' => '6', 'field' => 'area'),            array('db' => '`s_company`.`postal_code`',            'dt' => '7', 'field' => 'postal_code'),            array('db' => '`s_company`.`qty_permit`',             'dt' => '8', 'field' => 'qty_permit'),            array('db' => '`s_company`.`manager_codemeli`',       'dt' => '9', 'field' => 'manager_codemeli'),            array('db' => '`s_company`.`tele1`',                  'dt' => '10', 'field' => 'tele1'),            array('db' => '`s_company`.`tele2`',                  'dt' => '11', 'field' => 'tele2'),            array('db' => '`s_company`.`fax`',                    'dt' => '12', 'field' => 'fax'),            array('db' => '`s_company`.`manager_lastname`',       'dt' => '13', 'field' => 'manager_lastname'),            array('db' => '`s_company`.`activity`',               'dt' => '14', 'field' => 'activity'),            array('db' => '`s_company`.`address`',                'dt' => '15', 'field' => 'address'),            array('db' => '`s_company`.`is_water_counter`',       'dt' => '16', 'field' => 'is_water_counter'),            array('db' => '`s_company`.`company_type`',           'dt' => '17', 'field' => 'company_type'),            array('db' => '`s_company`.`manager_name`',           'dt' => '18', 'field' => 'manager_name'),        );        $joinQuery = "FROM  `{$table}`  ";//        $extraWhere = 'ORDER BY \'`s_charge_debit`.`charge_debit_id`\' ASC';        echo json_encode(//            SSPCustom::simple( $_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery)            SSPCustom::simple($_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery, '', '', '')        );    }    public function getUser()    {        if ($_POST["contractNumber"]) {            $data = AsrModel::fetch_user_by_contract_number($_POST["contractNumber"]);            $row = array(                'contractNumber' => $data['contract_number'],                'contractName' => $data['contract_name'],                'waterCounter' => $data['is_water_counter'],                'companyType' => $data['company_type'],                'area' => $data['area'],            );            echo json_encode($row);        }    }    public function actionUsers()    {        if (isset($_POST['contractNumber']) && $_POST['action'] == 'updateListUser') {            var_dump($_POST);//            exit();            $contractName =   $_POST['contractName'];            $contractNumber = $_POST['contractNumber'];            $area =           $_POST['area'];            $companyType =    $_POST['companyType'];            $waterCounter =   $_POST['waterCounter'];            $contractNumber = $_POST['contractNumber'];            AsrModel::update_user($contractName, $contractNumber, $area, $companyType, $waterCounter, $contractNumber);        }        if (isset($_REQUEST['id'])) {            $id = intval($_REQUEST['id']);            $data = AsrModel::fetch_bill_payed_bank_by_id($id);            ViewAdmin::renderPartial("/asr/user/list-user-edit.php", $data);        }    }    // هزینه شارژ    public function invoiceCatalog()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1820 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['btn-report'])) {            $this->report_invoice($_POST);        } else {            ViewAdmin::render("/asr/financial/invoice-catalog.php");        }    }    // هزینه نوسازی بازسازی    private function report_invoice($post)    {        $info['startIndex'] = $post['start'];        $info['endIndex'] = $post['end'];        $contract = explode('-', $post['gharardad']);        if ($contract[1] > null) {            $contract = $contract[0] . '-' . $contract[1];        } else {            $contract = null;        }        $info['contract_number'] = $contract;        $info['rrn'] = $post['codePeygiry'];        $info['start-date'] = $post['start-date'];        $info['end-date'] = $post['end-date'];//        $info['start-date'] = str_replace('/', '-', $info['start-date']);//        $info['end-date'] = str_replace('/', '-', $info['end-date']);        $data = $this->fetch_invoice($info);        if (isset($data['invoice'])) {            ViewAdmin::render("/asr/financial/invoice-catalog.php", $data);        } else {            $data['eroor'] = "مفداری وجود ندارد";            ViewAdmin::render("/asr/financial/invoice-catalog.php", $data);        }    }    private function fetch_invoice($info)    {        if ($info['endIndex'] > 0) {            $data['invoice'] = AsrModel::fetch_invoice_between($info['startIndex'], $info['endIndex']);            $data['sum-qty'] = AsrModel::sum_qty_between($info['startIndex'], $info['endIndex']);            $data['sum-price'] = AsrModel::sum_price_between($info['startIndex'], $info['endIndex']);            $data['catalog-type'] = 'از صورتحساب شماره' . '  ' . $info['startIndex'] . ' ' . 'الی' . '  ' . $info['endIndex'];        }        if ($info['contract_number'] > 0) {            $data['invoice'] = AsrModel::fetch_invoice_by_contract($info['contract_number']);            $data['sum-qty'] = AsrModel::sum_qty_between(null, null, $info['contract_number']);            $data['sum-price'] = AsrModel::sum_price_between(null, null, $info['contract_number']);            $data['catalog-type'] = 'صورتحساب شماره قرارداد' . '  ' . $info['contract_number'];        }        if ($info['rrn'] > 0) {            $data['invoice'] = AsrModel::fetch_invoice_rrn($info['rrn']);        }        if (strlen($info['start-date']) > 0 AND strlen($info['end-date']) > 0) {            $info['start-date'] = ' ' . test_input($info['start-date']) . ' ';            $info['end-date'] = ' ' . test_input($info['end-date']) . ' ';            $data['invoice'] = AsrModel::fetch_invoice_between_date($info['start-date'], $info['end-date']);            $data['sum-qty'] = AsrModel::sum_qty_between(null, null, null, $info['start-date'], $info['end-date']);            $data['sum-price'] = AsrModel::sum_price_between(null, null, null, $info['start-date'], $info['end-date']);            $data['catalog-type'] = ' صورتحساب از تاریخ' . '  ' . $info['start-date'] . ' ' . 'الی' . '  ' . $info['end-date'];        }        if (isset($data)) {            return $data;        }    }    //datatables serverside    public function permitCheck()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        $data = $this->fetch_permit_check();        ViewAdmin::render("/asr/gate/catalog.php", $data);    }    private function fetch_permit_check()    {        $data = AsrModel::fetch_permit_check();        return $data;    }    public function permitCheckR()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        $data = $this->fetch_permit_check_right();        ViewAdmin::render("/asr/gate/catalog-right.php", $data);    }    private function fetch_permit_check_right()    {        $data = AsrModel::fetch_permit_check_right();        return $data;    }    public function permitCheckL()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 AND $_SESSION['roleId'] > 1819) {            if (!isset($_SESSION['roleId'])) {                header("location: ../user/login");                session_destroy();                exit();            }            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        $data = $this->fetch_permit_check_left();        ViewAdmin::render("/asr/gate/catalog-left.php", $data);    }    private function fetch_permit_check_left()    {        $data = AsrModel::fetch_permit_check_left();        return $data;    }    public function permitCheckAjax()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        $data = $this->fetch_permit_check();        ob_start();        ViewAdmin::renderPartial("/asr/gate/ajaxCatalog.php", $data);        $output = ob_get_clean();        echo json_encode(array(            'status' => true,            'html' => $output,        ));    }    public function permitCheckAjaxRight()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        $data = $this->fetch_permit_check_right();        $data = json_encode($data);        echo $data;    }    public function permitCheckAjaxLeft()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        $data = $this->fetch_permit_check_left();        $data = json_encode($data);        echo $data;    }    public function catalogPermit($pageIndex, $date = null)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if ($pageIndex <= 0) {            $pageIndex == 1;            return $pageIndex;        }        $countPage = 300;        $startIndex = ($pageIndex - 1) * $countPage;        $data['records'] = AsrModel::fetch_catalog_permit($startIndex, $countPage);        $recordsCount = AsrModel::count_catalog_permit();        $data['pageCount'] = ceil($recordsCount / $countPage);        $data['pageIndex'] = $pageIndex;        ViewAdmin::render("/asr/gate/catalog-permit.php", $data);    }    public function catalog()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 AND $_SESSION['roleId'] > 1819 ) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        ViewAdmin::render("/asr/gate/catalog-server-side.php");    }    //datatables serverside    public function catalogServerSide()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 AND $_SESSION['roleId'] > 1819 ) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (!isset($_SESSION['user_id'])) {            header('location:' . fullbaseUrl() . '/user/login');            exit;        }        $table = 's_exit_permit';        $primaryKey = 'exit_permit_id';// Array of database columns which should be read and sent back to DataTables.// The `db` parameter represents the column name in the database, while the `dt`// parameter represents the DataTables column identifier - in this case object// parameter names        global $config;        $sql_details = array(            'user' => $config ['db']['user'],            'pass' => $config ['db']['pass'],            'db' => $config ['db']['name'],            'host' => $config ['db']['host'],        );        $joinQuery = "FROM   `{$table}`  ";        $columns = array(            array('db' => '`s_exit_permit`.`license_plate`', 'dt' => 'license_plate', 'field' => 'license_plate'),            array('db' => '`s_exit_permit`.`cargo`', 'dt' => 'cargo', 'field' => 'cargo'),            array('db' => '`s_exit_permit`.`driver_name`', 'dt' => 'driver_name', 'field' => 'driver_name'),            array('db' => '`s_exit_permit`.`issue_date`', 'dt' => 'issue_date', 'field' => 'issue_date'),            array('db' => '`s_exit_permit`.`due_date`', 'dt' => 'due_date', 'field' => 'due_date'),            array('db' => '`s_exit_permit`.`car_type`', 'dt' => 'car_type', 'field' => 'car_type'),            array('db' => '`s_exit_permit`.`exit_done`', 'dt' => 'exit_done', 'field' => 'exit_done'),            array('db' => '`s_exit_permit`.`permit_rand`', 'dt' => 'permit_rand', 'field' => 'permit_rand'),            array('db' => '`s_exit_permit`.`exit_permit_hash`', 'dt' => 'exit_permit_hash', 'field' => 'exit_permit_hash'),            array('db' => '`s_company`.`company_name`', 'dt' => 'company_name', 'field' => 'company_name'),            array('db' => '`s_company`.`contract_number`', 'dt' => 'contract_number', 'field' => 'contract_number'),        );        $joinQuery = "FROM (SELECT * FROM s_exit_permit ORDER BY exit_permit_id DESC   )   `{$table}` CROSS JOIN `s_company`  ON (`s_company`.`user_id` = `s_exit_permit`.`user_id` )  ";        /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         * If you just want to use the basic configuration for DataTables with PHP         * server-side, there is no need to edit below this line.         *///        $extraWhere = 'ORDER BY `s_exit_permit`.`exit_permit_id` DESC';        $extraWhere = "`s_exit_permit`.`exit_permit_id`";        if ($_POST["is_date_search"] == "yes") {            $extraWhere = "date(`s_exit_permit`.`issue_date`) BETWEEN date('{$_POST["start_date"]}') AND date('{$_POST["end_date"]}') ";        }        $groupBy = "s_exit_permit.exit_permit_id";        echo json_encode(            SSPCustom::simple($_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery, $extraWhere, '', '')        );    }    public function catalogExit($pageIndex)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 ) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if ($pageIndex <= 0) {            $pageIndex == 1;            return $pageIndex;        }        $countPage = 50;        $startIndex = ($pageIndex - 1) * $countPage;        $data['records'] = AsrModel::fetch_catalog_permit($startIndex, $countPage);        $recordsCount = AsrModel::count_catalog_permit();        $data['pageCount'] = ceil($recordsCount / $countPage);        $data['pageIndex'] = $pageIndex;        ViewAdmin::render("/asr/gate/catalog-permit.php", $data);    }    public function fl($exitPermitHash = null)    {      //fetchLicense مقدار پیشفرض می تواند خالی باشد        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($exitPermitHash)) {            $exitDate = jdate('Y-m-d H:i:s');            if (!empty($exitPermitHash)) {                $db = Db::getInstance();                $db->modify("UPDATE s_exit_permit SET due_date=:exitDate , exit_done=1 WHERE exit_permit_hash=:exitPermitHash", array(                    'exitDate' => $exitDate,                    'exitPermitHash' => $exitPermitHash,                ));                $permit = AsrModel::fetch_by_exit_permit_hash($exitPermitHash);                $gateName = "کاربر" . " " . $_SESSION['username'];                AsrModel::insert_manual_license($permit['license_plate'], $gateName, $permit['permit_rand'], $permit['company_name'], $permit['car_type'], $permit['cargo'], $permit['driver_name'], $permit['issue_date'], $exitDate, $exitPermitHash);                $db->modify("DELETE FROM s_check_permit WHERE exit_permit_hash=:exitPermitHash", array(                    'exitPermitHash' => $exitPermitHash,                ));            }            messageAdmin("success", '<span>برگه خروج با موفقیت ثبت شد</span><br><br><a id="backform" class="btn btn-default" onclick="window.location.href=\'/asr/fl\'">بازگشت</a>', true);        } elseif (!isset($_POST['btn-search'])) {            ViewAdmin::render("/asr/gate/fetch-license.php");        } else {            $licensePlate = 'ایران' . test_input($_POST['ir']) . " " . test_input($_POST['threeDigit']) . test_input($_POST['letter']) . test_input($_POST['twoDigit']);            $data = AsrModel::fetch_by_license($licensePlate);            $data['past'] = AsrModel::fetch_exited_license_catalog($licensePlate);            if (!isset($data['license_plate'])) {                $message = "<span>این پلاک برگه خروج فعال ندارد</span>";                $data['message'] = $message;            }            ViewAdmin::render("/asr/gate/fetch-license.php", $data);        }    }    public function lastLogin()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1818) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        ViewAdmin::render("/asr/user/last-login.php");    }    public function lastLoginServerSide()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1818) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        $table = 's_login';        $primaryKey = 'login_id';        global $config;        $sql_details = array(            'user' => $config ['db']['user'],            'pass' => $config ['db']['pass'],            'db' => $config ['db']['name'],            'host' => $config ['db']['host'],        );        $joinQuery = "FROM   `{$table}`  ";        $columns = array(            array('db' => '`s_login`.`ip_address`', 'dt' => 'ip_address', 'field' => 'ip_address'),            array('db' => '`s_login`.`login_time`', 'dt' => 'login_time', 'field' => 'login_time'),            array('db' => '`s_login`.`platform`', 'dt' => 'platform', 'field' => 'platform'),            array('db' => '`s_login`.`browser_name`', 'dt' => 'browser_name', 'field' => 'browser_name'),            array('db' => '`s_login`.`browse_version`', 'dt' => 'browse_version', 'field' => 'browse_version'),            array('db' => '`s_login`.`is_mobile`', 'dt' => 'is_mobile', 'field' => 'is_mobile'),            array('db' => '`s_company`.`company_name`', 'dt' => 'company_name', 'field' => 'company_name'),            array('db' => '`s_user`.`username`', 'dt' => 'username', 'field' => 'username'),            array('db' => '`s_company`.`address`', 'dt' => 'address', 'field' => 'address'),        );        $joinQuery = "FROM (SELECT * FROM s_login ORDER BY login_id DESC   )   `{$table}` LEFT JOIN `s_company`  ON (`s_company`.`user_id` = `s_login`.`user_id` )         LEFT JOIN `s_user` ON (`s_user`.`user_id` = `s_login`.`user_id`)  ";        $extraWhere = "`s_login`.`login_id`";        if ($_POST["is_date_search"] == "yes") {            $extraWhere = "date(`s_login`.`login_time`) BETWEEN date('{$_POST["start_date"]}') AND date('{$_POST["end_date"]}') ";        }        $groupBy = "s_exit_permit.exit_permit_id";        echo json_encode(            SSPCustom::simple($_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery, $extraWhere, '', '')        );    }    public function register()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1820 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['user-name'])) {            $this->registerCheck();        } else {            $this->registerForm();        }    }    private function registerCheck()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        $username = $_POST['user-name'];        $password1 = $_POST['password1'];        $password2 = $_POST['password2'];        $contract_name = $_POST['contract-name'];        $area = $_POST['area'];        $record = UserModel::fetch_by_username($username);        if ($record != null) {            messageAdmin('fail', _already_registered, true);        }        if (strlen($password1) < 7 || strlen($password2) < 7) {            messageAdmin('fail', _weak_password, true);        }        if ($password1 != $password2) {            messageAdmin('fail', _password_not_match, true);        }        $hashedPassword = encryptPassword($password1);        $creationTime = jdate('Y-m-d H:i:s');        UserModel::insert($username, $hashedPassword, $contract_name, $area, $creationTime);        $data = array(            'username' => $username,            'password' => $password1,            'contract_name' => $contract_name,            'area' => $area,            'creationTime' => $creationTime,        );        ViewAdmin::render("/asr/user/register-user.php", $data);    }    private function registerForm()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        ViewAdmin::render("/asr/user/register-user.php");    }// گزارش تردد    public function traffic($pageIndex = null)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if (isset($_POST['btn-report'])) {            $info['start-date'] = test_input($_POST['start-date']);            $info['end-date'] = test_input($_POST['end-date']);            $contract = explode('-', $_POST['gharardad']);            if ($contract[1] > null) {                $contract = $contract[0] . '-' . $contract[1];            } else {                $contract = null;            }            $info['contract_number'] = $contract;            $info['type'] = $_POST['type'];            $info['company'] = $_POST['company'];            $info['driver'] = $_POST['driver'];            $info['cargo'] = $_POST['cargo'];            $info['car-type'] = $_POST['car-type'];            if ($_POST['ir'] != null) {                $info['license-plate'] = 'ایران' . test_input($_POST['ir']) . " " . test_input($_POST['threeDigit']) . test_input($_POST['letter']) . test_input($_POST['twoDigit']);            }            ////            if ($pageIndex<=0){//                $pageIndex==1;//                return $pageIndex;//            }//            dump($info);            //            $data = $this->fetch_traffic($info);            if (isset($data)) {                ViewAdmin::render("/asr/gate/traffic-catalog.php", $data);            } else {                $data['error'] = "مفداری وجود ندارد";                ViewAdmin::render("/asr/gate/traffic-catalog.php", $data);            }        } else {            ViewAdmin::render("/asr/gate/traffic-catalog.php");        }    }    private function fetch_traffic($info)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($info['start-date'] > 0) {//            $countPage = 50;//            $startIndex = ($pageIndex-1) * $countPage;//            $data['records'] = AsrModel::fetch_catalog_permit();//            $recordsCount = AsrModel::count_catalog_permit();//            $data['pageIndex'] =//                $pageIndex;            //            $data['catalog'] = AsrModel::fetch_traffic_between($info['start-date'], $info['end-date']);//            $data['pageCount'] = AsrModel::count_traffic($info['start-date'], $info['end-date'] );        }//        if ($info['contract_number']>0) {//            $data['invoice'] = AsrModel::fetch_water_bill_by_contract_number($info['contract_number']);//        }//        if ($info['rrn']>0) {//            $data['invoice'] = AsrModel::fetch_water_bill_by_rrn($info['rrn']);//        }//        if ($info['payment_time']>0) {//            $data['invoice'] = AsrModel::fetch_water_bill_by_payment_time($info['payment_time']);//        }        if (isset($data)) {            return $data;        }    }    public function catalogTraffic()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['btn-report'])) {//            $contract = explode('-', $_POST['gharardad']);//            if ($contract[1] > null) {//                $contract = $contract[0] . '-' . $contract[1];//            } else {//                $contract = null;//            }//            $info['contract_number'] = $contract;            $info['start-date'] = test_input($_POST['start-date']);            $info['end-date'] = test_input($_POST['end-date']);            $info['company'] = $_POST['company'];            $info['driver'] = $_POST['driver'];            $info['cargo'] = $_POST['cargo'];            $info['car-type'] = $_POST['car-type'];            if (strlen($_POST['ir']) > 0) {                $ir = 'ایران' . $_POST['ir'];            } else {                $ir = null;            }            if (strlen($_POST['threeDigit']) > 0) {                if (strlen($_POST['threeDigit']) < 3) {                    $threeDigit = '_' . $_POST['threeDigit'];                } else {                    $threeDigit = $_POST['threeDigit'];                }            } else {                $threeDigit = null;            }            if (strlen($_POST['letter']) > 0) {                $letter = $_POST['letter'];            } else {                $letter = null;            }            if (strlen($_POST['twoDigit']) > 0) {                $twoDigit = $_POST['twoDigit'];            } else {                $twoDigit = null;            }            if ($ir == null) {                $info['license-plate'] = test_input($threeDigit) . test_input($letter) . test_input($twoDigit);            } else {                $info['license-plate'] = test_input($ir) . " " . test_input($threeDigit) . test_input($letter) . test_input($twoDigit);            }            $info['license-plate'] = isNull($info['license-plate']);//            var_dump($info);            if (strlen($info['start-date']) == 0 && strlen($info['end-date']) == 0 && strlen($info['car-type']) == 0 &&                strlen($info['company']) == 0 && strlen($info['driver']) == 0 && strlen($info['cargo']) == 0 && strlen($info['car-type']) == 0 &&                strlen($info['license-plate']) == 0            ) {                $info['message'] = "حداقل یکی از فیلتر های جستجو را کامل فرمایید";            }            if (isset($info)) {                ViewAdmin::render("/asr/gate/catalog-traffic-server-side.php", $info);            }        } else {            ViewAdmin::render("/asr/gate/catalog-traffic-server-side.php");        }    }    public function catalogTrafficServerSide($startDate = null, $endDate = null, $companyName = null, $licensePlate = null, $driver = null, $carType = null, $cargo = null)    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1822 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        // DB table to use        $table = 's_exited';        $primaryKey = 'exited_id';        global $config;        $sql_details = array(            'user' => $config ['db']['user'],            'pass' => $config ['db']['pass'],            'db' => $config ['db']['name'],            'host' => $config ['db']['host'],        );        $columns = array(            array('db' => 'company_name', 'dt' => 'company_name'),            array('db' => 'license_platte', 'dt' => 'license_plate'),            array('db' => 'channel', 'dt' => 'channel'),            array('db' => 'exite_date', 'dt' => 'exit_date'),            array('db' => 'cargo', 'dt' => 'cargo'),            array('db' => 'driver_name', 'dt' => 'driver_name'),            array('db' => 'issue_date', 'dt' => 'issue_date'),            array('db' => 'car_type', 'dt' => 'car_type'),            array('db' => 'permit_rand', 'dt' => 'permit_rand'),        );        $joinQuery = " ORDER BY `s_exited`.`exited_id` DESC ";        $param = 'ORDER BY `s_exited`.`exited_id` DESC';        $date = jdate("Y-m-d");//        $extraWhere= '`exite_date`>'.'"'.$date.'"'."";//        $extraWhere= "exite_date BETWEEN '{$info['start-date']}' AND '{$info['end-date']}'";        if (strlen($companyName) > 0 AND $companyName == !0) {            $extraWhere = "`company_name` LIKE '%{$companyName}%'";        } elseif (strlen($driver) > 0 AND $driver == !0) {            $extraWhere = "`driver_name` LIKE '%{$driver}%'";        } elseif (strlen($carType) > 0 AND $carType == !0) {            $extraWhere = "`car_type` LIKE '%{$carType}%'";        } elseif (strlen($cargo) > 0 AND $cargo == !0) {            $extraWhere = "`cargo` LIKE '%{$cargo}%'";        } elseif (isset($licensePlate) AND strlen($licensePlate) == 2 AND is_numeric($licensePlate) == true) {            if ($startDate > 0 AND $endDate > 0) {                $extraWhere = "`license_platte` LIKE '____________{$licensePlate}%' AND exite_date BETWEEN '{$startDate}' AND '{$endDate}' ";            } else {                $extraWhere = "`license_platte` LIKE '____________{$licensePlate}%'";            }        } elseif (isset($licensePlate) AND strlen($licensePlate) == 2 AND is_string($licensePlate) == true) {            $extraWhere = "`license_platte` LIKE '___________{$licensePlate}%'";        } elseif (isset($licensePlate) AND strlen($licensePlate) == 3 AND is_numeric($licensePlate) == true) {            $extraWhere = "`license_platte` LIKE '________{$licensePlate}%'";        } elseif (isset($licensePlate)) {            $extraWhere = "`license_platte` LIKE '%{$licensePlate}%'";        } elseif ($startDate > 0 AND $endDate > 0) {            $extraWhere = "exite_date BETWEEN '{$startDate}' AND '{$endDate}'";        }        if (strlen($startDate) > 1 & strlen($endDate) > 1 & isset($licensePlate)) {            $extraWhere = "`license_platte` LIKE '{$licensePlate}%' AND `exite_date` BETWEEN '{$startDate}' AND '{$endDate}' ";        }//        echo $extraWhere;        echo json_encode(            SSPCustom::simple($_POST, $sql_details, $table, $primaryKey, $columns, '', $extraWhere, '')        );    }    public function changeUserPass()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1823 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['contract-number'])) {            $data = AsrModel::fetch_user_by_contract_number($_POST['contract-number']);            ViewAdmin::render("/asr/user/change-user-pass.php", $data);        } elseif (isset($_POST['change-pass'])) {            $password1 = $_POST['password1'];            $password2 = $_POST['password2'];            if (strlen($password1) < 7 || strlen($password2) < 7) {                messageAdmin('fail', _weak_password, true);            }            if ($_POST['check'] !== 'yes') {                header('Location: /asr/changeUserPass');            }            if ($password1 != $password2) {                messageAdmin('fail', _password_not_match, true);            }            $userName = $_POST['user-name'];            $pass = $_POST['password1'];            $changePassDate = jdate('Y-m-d H:i:s');            $hashPass = encryptPassword($pass);            $resetBy = $_SESSION['name'];            AsrModel::reset_pass($userName, $hashPass, $changePassDate, $resetBy);            $data = array(                'username' => $_POST['user-name'],                'password' => $password1,                'contract_name' => $_POST['contract-name'],                'company_name' => $_POST['company-name'],                'change_pass_date' => $changePassDate,                'reset_by' => $resetBy,            );            ViewAdmin::render("/asr/user/change-user-pass.php", $data);        } else {            ViewAdmin::render("/asr/user/change-user-pass.php");        }    }    public function wsdtest()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (isset($_POST['btn-insert'])) {            $dir = $_POST['btn-insert'];            $counter = 0;            $counterSuccess = 0;            $counterFailed = 0;            $CSVfp = fopen("$dir", "r");            if ($CSVfp !== FALSE) {                while (!feof($CSVfp)) {                    $row = fgetcsv($CSVfp, "*");                    $explodeData = explode("*", $row[0]);//                var_dump($explodeData);                    $contractNumber = "415-" . $explodeData[0];                    $contractNumber = str_replace('﻿', '', $contractNumber);                    $userDetailes = AsrModel::fetch_bill_by_contract_number($contractNumber);                    $userId = $userDetailes[0]['user_id'];                    $pastWaterCounter = $explodeData[1];                    $period_number = 68;                    $period_name = 'تیر-مرداد-شهریور';                    $readDate = "1398-06-31 10:00:00";                    if (isset($userId)) {                        AsrModel::read_from_csv($userId, $period_number, $period_name, $readDate, $pastWaterCounter);                        $data['موفق'][] = $contractNumber . '->' . "ثبت شد";                        $counterSuccess++;                    } else {                        $data['ناموفق'][] = $contractNumber . '->' . "کاربر پنل کاربری ندارد- قبض صادر نگردید";                        $counterFailed++;                    }                    $counter++;                }                $data['تعداد کل'] = $counter;                $data['تعداد صدور موفق'] = $counterSuccess;                $data['تعداد ناموفق'] = $counterFailed;//                if (isset($periodLastId)) {//                    ViewAdmin::render("/asr/wsd/summery.php", $data);//                }                dump($data);            }            fclose($CSVfp);        } else {            ViewAdmin::render("/asr/wsd/water-reader.php");        }    }    public function counter_reader()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        $todayDate = jdate('Y-m-d');        $period = AsrModel::fetch_water_period();        if ($todayDate >= $period['start_date'] AND $todayDate <= $period['end_date']) {            if (isset($_POST['gharardad'])) {                $periodId = $period['period_id'] - 1;                $contractNumber = "415-" . $_POST['gharardad'];                $data['lastCounter'] = AsrModel::fetch_last_water_counter($contractNumber, $periodId);                $data['newCounter'] = AsrModel::fetch_new_water_counter($data['lastCounter']['user_id'], $period['period_id']);                ViewAdmin::render("/asr/wsd/reader.php", $data);            } elseif (isset($_POST['btn-insert'])) {                $newPeriod = $_POST['last_period_id'] + 1;                $isInserted = AsrModel::fetch_new_water_counter($_POST['id'], $newPeriod);                $readerName = $_SESSION['name'];                //اگر وضعیت کنتور انتخاب شد عدد کنتور قبلی تکرار گردد                if ($_POST['status']==0){                    $counterNumber = $_POST['new_counter'];                }else{                    $counterNumber = $_POST['last_counter'];                }                //                if ($isInserted == null) {                    AsrModel::insert_water_counter($_POST['id'], $newPeriod, $period['period_name'], $counterNumber, $_POST['status'], $readerName);                    messageAdmin("success", '<span>قرائت کنتور مشترک<mark dir="ltr">' . $counterNumber . '</mark> با شماره کنتور <mark>' . $_POST['new_counter'] . '</mark>ثبت گردید</span><br><br><a class="btn btn-default" href="/asr/counter_reader">بازگشت</a>', true);                } else {                    AsrModel::update_water_counter($_POST['id'], $newPeriod, $counterNumber, $_POST['status'], $readerName);                    messageAdmin("success", '<span>قرائت کنتور مشترک<mark dir="ltr">' . $_POST['contract_number'] . '</mark> با شماره کنتور <mark>' . $_POST['new_counter'] . '</mark>ثبت گردید</span><br><br><a class="btn btn-default" href="/asr/counter_reader">بازگشت</a>', true);                }            } else {                ViewAdmin::render("/asr/wsd/reader.php");            }        } else {            messageAdmin("fail", '<span>دوره قرائت کنتور فعال نیست</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }    }    public function catalogCounter()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        $data['period'] = AsrModel::fetch_all_water_period();        ViewAdmin::render("/asr/wsd/catalog-counter.php", $data);    }    //datatables serverside    public function catalogCounterServerSide()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821 AND $_SESSION['roleId'] > 1819) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (!isset($_SESSION['user_id'])) {            header('location:' . fullbaseUrl() . '/user/login');            exit;        }        // DB table to use        $table = 's_water_counter';        $primaryKey = 'water_counter_id';        global $config;        $sql_details = array(            'user' => $config ['db']['user'],            'pass' => $config ['db']['pass'],            'db' => $config ['db']['name'],            'host' => $config ['db']['host'],        );        $joinQuery = "FROM   `{$table}`  ";        $columns = array(            array('db' => '`s_water_counter`.`period_name`', 'dt' => 'period_name', 'field' => 'period_name'),            array('db' => '`s_water_counter`.`period_number`', 'dt' => 'period_number', 'field' => 'period_number'),            array('db' => '`s_water_counter`.`counter`', 'dt' => 'counter', 'field' => 'counter'),            array('db' => '`s_water_counter`.`status`', 'dt' => 'status', 'field' => 'status'),            array('db' => '`s_water_counter`.`read_date`', 'dt' => 'read_date', 'field' => 'read_date'),            array('db' => '`s_water_counter`.`change_date`', 'dt' => 'change_date', 'field' => 'change_date'),            array('db' => '`s_water_counter`.`reader_name`', 'dt' => 'reader_name', 'field' => 'reader_name'),            array('db' => '`s_company`.`company_name`', 'dt' => 'company_name', 'field' => 'company_name'),            array('db' => '`s_company`.`contract_number`', 'dt' => 'contract_number', 'field' => 'contract_number'),            array('db' => '`s_company`.`address`', 'dt' => 'address', 'field' => 'address'),        );//        $joinQuery = "FROM (SELECT * FROM s_exit_permit ORDER BY exit_permit_id DESC /MyLimit/ )   `{$table}` LEFT JOIN `s_company`  ON (`s_company`.`user_id` = `s_exit_permit`.`user_id` )  ";        $joinQuery = "FROM (SELECT * FROM s_water_counter ORDER BY water_counter_id DESC  )   `{$table}` CROSS JOIN `s_company`  ON (`s_company`.`user_id` = `s_water_counter`.`user_id` )  ";        /* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *         * If you just want to use the basic configuration for DataTables with PHP         * server-side, there is no need to edit below this line.         */        $extraWhere = 'ORDER BY `s_water_counter`.`water_counter_id` DESC';//        $extraWhere ="`s_exit_permit`.`exit_permit_id`<10";        $groupBy = "s_exit_permit.exit_permit_id";        echo json_encode(//            SSPCustom::simple( $_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery)            SSPCustom::simple($_POST, $sql_details, $table, $primaryKey, $columns, $joinQuery, '', '', '', $extraWhere)        );    }    public function exportCounterReader()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (!isset($_SESSION['user_id'])) {            header('location:' . fullbaseUrl() . '/user/login');            exit;        }        $periodId = $_POST['period-number'];        $periodData = AsrModel::fetch_water_period_by_id($periodId);        $delimiter = ",";        $filename = "reader" . date('Y-m-d') . ".csv";        //create a file pointer        $f = fopen('php://memory', 'w');        for ($i = 0; $i < count($periodData); $i++) {            $contractNumber = explode('-', $periodData[$i]['contract_number']);            $contractNumber = $contractNumber[1];            $counter = $periodData[$i]['counter'];            $readDate = $periodData[$i]['read_date'];            $readDate = explode(' ', $readDate);            $readDate = $readDate[0];            $readDate = str_replace('-', '/', $readDate);            $lineData = array($contractNumber, $counter, $readDate, '36');//            $last = $i - 1;//            fwrite($f, $contractNumber);//            if ($i != $last) {//                fwrite($f, ",");//            }//            fwrite($f, "\n");            fputcsv($f, $lineData, $delimiter);        }        fseek($f, 0);//        fclose($f);        header('Content-Type: text/csv');//        header('Content-Type: text');        header('Content-Disposition: attachment; filename="' . $filename . '";');        fpassthru($f);//        dump($periodData);    }    public function counterReader0()    {        if (!isset($_SESSION['roleId'])) {            header("location: ../user/login");            session_destroy();            exit();        }        if ($_SESSION['roleId'] != 1821) {            messageAdmin("fail", '<span>شما دسترسی به این قسمت ندارید</span><br><br><a class="btn btn-default" href="../asr/admin">بازگشت</a>', true);        }        if (!isset($_SESSION['user_id'])) {            header('location:' . fullbaseUrl() . '/user/login');            exit;        }        $periodId = $_POST['period_id'];        $userIdHasWaterCounter = AsrModel::fetch_is_water_counter();        $counterLoop = 0;        for ($i = 0; $i < count($userIdHasWaterCounter); $i++) {            $userId = $userIdHasWaterCounter[$i]['user_id'];            $counterIsReade = AsrModel::fetch_is_water_counter_reade($userId, $periodId);            if (!isset($counterIsReade['counter'])) {                $lastCounterNumber = AsrModel::fetch_last_water_counter_by_userid($userId, $periodId);                if (isset($lastCounterNumber['counter'])) {                    $lastCounter = $lastCounterNumber['counter'];                } else {                    $lastCounter = 0;                }                $lastPeriodName = $lastCounterNumber['period_name'];//                    echo $lastCounter . $lastPeriodName . br();                AsrModel::insert_last_water_counter($userId, $periodId, $lastCounter, $lastPeriodName);                $counterLoop++;            }        }        message("success", '<span>تعداد کارکرد  <mark>' . $counterLoop . '</mark>  عدد کنتور با کارکرد صفر ثبت گردید  </span><br><br><a class="btn btn-default" href="../asr/catalogCounter">بازگشت</a>', true);//        echo $counter.br();    }}